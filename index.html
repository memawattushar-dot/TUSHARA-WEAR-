<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUSHARA-WEAR AI Assistant App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styling for branding and scrollbar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .chat-container {
            max-height: calc(100vh - 160px); /* Adjust height for input and header */
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Tushara Brand Colors */
        .brand-bg {
            background-color: #1e3a8a; /* Deep Blue */
        }
        .brand-text-accent {
            color: #f59e0b; /* Amber/Gold accent */
        }
        .brand-bg-accent {
            background-color: #f59e0b;
        }
        .user-message {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .ai-message {
            background-color: #1e3a8a;
            color: white;
        }
    </style>
    <!-- PWA Manifest and Theme Settings (Dynamically registered in JS) -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="brand-bg text-white p-4 shadow-lg sticky top-0 z-10">
        <h1 class="text-xl font-bold">TUSHARA-WEAR AI <span class="brand-text-accent">Assistant</span></h1>
        <p class="text-sm opacity-80">Ask any question about our products, style, or fashion.</p>
    </header>

    <!-- Main Chat Display Area -->
    <main class="flex-grow p-4 md:p-6 pb-20">
        <div id="chat-container" class="chat-container space-y-4">
            <!-- Initial Welcome Message -->
            <div class="flex justify-start">
                <div class="ai-message p-3 rounded-xl rounded-tl-none max-w-xs md:max-w-md shadow-md">
                    üëã <strong>Hello!</strong> I am the TUSHARA-WEAR AI Assistant. Ask about your styling needs or any fashion trends.
                </div>
            </div>
            <!-- Messages will be inserted here -->
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden flex justify-start mt-4">
            <div class="p-3 bg-gray-200 rounded-xl rounded-tl-none max-w-xs md:max-w-md shadow-md">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: -0.32s;"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: -0.16s;"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area - Sticky Footer -->
    <div class="fixed bottom-0 left-0 w-full bg-white p-4 shadow-2xl z-20">
        <div class="flex space-x-3 max-w-4xl mx-auto">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Type your question here..." 
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#f59e0b] focus:border-[#f59e0b]"
                onkeydown="if(event.key === 'Enter') document.getElementById('send-btn').click();"
            >
            <button 
                id="send-btn" 
                onclick="sendMessage()" 
                class="brand-bg-accent text-white p-3 rounded-lg font-semibold shadow-md hover:bg-yellow-600 transition duration-150 flex items-center justify-center disabled:opacity-50"
            >
                Send
            </button>
        </div>
        <p id="status-message" class="text-xs text-gray-500 mt-2 text-center hidden">AI Assistant is typing...</p>
    </div>

    <!-- JavaScript Logic: For AI, PWA, and Chatting -->
    <script>
        // --- 1. AI Configuration and State ---
        const API_KEY = ""; // Keep key empty, Canvas will provide it automatically
        const MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
        
        let chatHistory = [];
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-btn');
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // System instruction guides the model's persona and response style
        const systemInstruction = "Act as the expert customer service representative and fashion stylist for TUSHARA-WEAR. Provide concise, friendly, and helpful advice. Use Google Search to provide information on fashion trends, but always link it to men's clothing and style. Respond in English.";

        // --- Utility Functions ---

        /** Scrolls the chat container to the bottom. */
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /** Creates and appends a message bubble to the chat container. */
        function appendMessage(role, text, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 rounded-xl max-w-xs md:max-w-md shadow-md transition-all duration-300 ${
                role === 'user' 
                    ? 'user-message rounded-br-none' 
                    : 'ai-message rounded-tl-none'
            }`;
            messageBubble.innerHTML = role === 'user' ? text : formatMarkdown(text);
            
            messageWrapper.appendChild(messageBubble);

            if (sources.length > 0 && role !== 'user') {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'text-xs mt-1 p-2 bg-gray-100 rounded-lg border border-gray-200 text-black';
                sourcesDiv.innerHTML = '<strong>üîç Sources:</strong><ul class="list-disc ml-4 mt-1 space-y-0.5">' + 
                    sources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-blue-600 hover:underline">${s.title || s.uri}</a></li>`).join('') +
                    '</ul>';
                messageWrapper.appendChild(sourcesDiv);
            }

            chatContainer.appendChild(messageWrapper);
            scrollToBottom();
        }

        /** Converts basic Markdown in AI response to HTML for display. */
        function formatMarkdown(text) {
            // Bold (**text** or *text*)
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
            // Newlines to breaks
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // --- 2. AI Interaction Core Logic ---

        /** Sends the user's message to the Gemini API. */
        async function fetchAIResponse(userQuery) {
            
            // Add user query to chat history for context (although current payload only uses current query)
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                
                // Enable Google Search grounding for up-to-date information
                tools: [{ "google_search": {} }], 
                
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            let response;
            let result;
            let delay = 1000;
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        // Too many requests - exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue; 
                    }

                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    result = await response.json();
                    break; // Success, exit loop

                } catch (error) {
                    // console.error("Fetch attempt failed:", error); // Left out to suppress console errors during backoff
                    if (i === maxRetries - 1) {
                        throw new Error("Failed to receive response after multiple retries.");
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            
            if (!result || !result.candidates || result.candidates.length === 0) {
                 throw new Error("Invalid response structure from API.");
            }

            const candidate = result.candidates[0];
            const text = candidate.content?.parts?.[0]?.text || "Sorry, I couldn't process that request.";

            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri); // Ensure only valid sources are kept
            }

            // Add AI response to history
            chatHistory.push({ role: "model", parts: [{ text: text }] });
            
            return { text, sources };
        }

        /** Handles sending the message and updating the UI. */
        async function sendMessage() {
            const query = userInput.value.trim();
            if (!query) return;

            // 1. Update UI for user message
            appendMessage('user', query);
            userInput.value = '';
            userInput.disabled = true;
            sendButton.disabled = true;
            statusMessage.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            scrollToBottom();

            try {
                // 2. Fetch AI response
                const { text, sources } = await fetchAIResponse(query);
                
                // 3. Update UI for AI response
                appendMessage('ai', text, sources);

            } catch (error) {
                console.error("Gemini API Error:", error);
                appendMessage('ai', `<strong>Error:</strong> The AI encountered a problem: ${error.message}. Please try again.`);
            } finally {
                // 4. Reset UI
                userInput.disabled = false;
                sendButton.disabled = false;
                statusMessage.classList.add('hidden');
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        }

        // --- 3. PWA Setup (Dynamic Service Worker Registration) ---
        
        /** Defines the content of the Service Worker file. */
        function getServiceWorkerContent() {
            const CACHE_NAME = 'tushara-wear-cache-v1';
            // List of core files to cache for offline use
            const urlsToCache = [
                '/TUSHARA-WEAR/',
                '/TUSHARA-WEAR/index.html',
                'https://cdn.tailwindcss.com', 
            ];

            // Service Worker logic
            return `
                const CACHE_NAME = '${CACHE_NAME}';
                const urlsToCache = [${urlsToCache.map(url => `'${url}'`).join(', ')}];

                self.addEventListener('install', event => {
                    console.log('[Service Worker] Installing...');
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                            .catch(err => console.error('Cache addAll failed:', err))
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => {
                            return response || fetch(event.request);
                        })
                    );
                });

                self.addEventListener('activate', event => {
                    const cacheWhitelist = [CACHE_NAME];
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheWhitelist.indexOf(cacheName) === -1) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                });
            `;
        }

        /** Dynamically registers the PWA Service Worker. */
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    try {
                        // Create a Blob from the Service Worker content
                        const swContent = getServiceWorkerContent();
                        const swBlob = new Blob([swContent], { type: 'application/javascript' });
                        const swUrl = URL.createObjectURL(swBlob);

                        // Register the Service Worker
                        navigator.serviceWorker.register(swUrl, { scope: '/TUSHARA-WEAR/' })
                            .then(registration => {
                                console.log('PWA ServiceWorker registered successfully:', registration.scope);
                            })
                            .catch(error => {
                                console.error('PWA ServiceWorker registration failed:', error);
                            });
                        
                        // Dynamically set the Manifest (using placeholder icons)
                        const manifest = {
                            "name": "TUSHARA-WEAR",
                            "short_name": "Tushara",
                            "description": "TUSHARA Menswear - AI Assistant PWA",
                            "start_url": "/TUSHARA-WEAR/",
                            "display": "standalone",
                            "background_color": "#ffffff",
                            "theme_color": "#1e3a8a",
                            "icons": [
                                // Using placeholder image URLs that generate an icon with the letter 'T'
                                { "src": "https://placehold.co/192x192/1e3a8a/ffffff?text=T", "sizes": "192x192", "type": "image/png" },
                                { "src": "https://placehold.co/512x512/1e3a8a/ffffff?text=T", "sizes": "512x512", "type": "image/png" }
                            ]
                        };
                        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                        const manifestUrl = URL.createObjectURL(manifestBlob);
                        
                        // Link the dynamically created manifest
                        const link = document.createElement('link');
                        link.rel = 'manifest';
                        link.href = manifestUrl;
                        document.head.appendChild(link);
                        
                    } catch (e) {
                        console.error("PWA Setup Error:", e);
                    }
                });
            }
        }

        // Initialize PWA on window load
        registerServiceWorker();
    </script>

</body>
</html>

        
