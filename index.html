<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUSHARA Assistant - Super Advanced AGI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Three.js Library for 3D Visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* General Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1f2937;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
        }
        /* Tab Styling */
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            border-bottom: 4px solid #10b981;
            color: #10b981;
            font-weight: 700;
        }
        /* Chat Styling */
        .chat-message.ai {
            background-color: #e0f2f1;
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        .chat-message.user {
            background-color: #a7f3d0;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Task Styling */
        .task-done {
            text-decoration: line-through;
            color: #6b7280;
        }
        /* 3D Container Styling */
        #three-container {
            width: 100%;
            height: 350px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #e2e8f0; 
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore Logging ko debug mode mein set karein (Zaroori)
        setLogLevel('debug');

        // --- GLOBAL CONFIG & STATE ---
        // App ID aur Firebase config Canvas environment se liye jaate hain
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;
        // Advanced Feature: Contextual Chat Memory - baat cheet ka silsila yaad rakhne ke liye
        let chatHistory = []; 
        
        // --- 3D GLOBAL VARIABLES ---
        let scene, camera, renderer, avatarGroup;
        let is3DInit = false;

        // --- TTS Helper Functions (PCM to WAV conversion) ---
        // Base64 string ko ArrayBuffer mein badalne ka function
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // PCM audio data ko WAV format mein badal kar Blob banane ka function
        function pcmToWav(pcm16, sampleRate = 16000) { 
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);

            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            // WAV file header (RIFF, fmt, data chunks)
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);

            // PCM data likhein
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        // --- Firebase and Auth Setup ---
        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config missing.");
                    document.getElementById('user-id-display').textContent = 'Firebase Config Missing';
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Custom token ya Anonymous sign-in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Auth state mein badlav ko sunne wala listener
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        loadTasks(); 
                        getStyleProfile(); 
                    } else {
                        userId = crypto.randomUUID(); // Guest mode ke liye
                        document.getElementById('user-id-display').textContent = `Guest ID: ${userId}`;
                    }
                    console.log("Firebase Auth Ready. User ID:", userId);
                });

            } catch (error) {
                console.error("Firebase setup ya sign-in mein error:", error);
                document.getElementById('user-id-display').textContent = 'Sign-in Error';
            }
        }
        
        // [Firestore Utility Functions]
        const TASK_COLLECTION_NAME = 'tushara_assistant_data';
        const PROFILE_DOC_ID = 'user_style_profile';
        
        function getTasksCollectionRef() {
            if (!userId || !db) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}
            return collection(db, `artifacts/${appId}/users/${userId}/${TASK_COLLECTION_NAME}`);
        }
        
        function getProfileDocRef() {
            if (!userId || !db) return null;
            // Private document path: /artifacts/{appId}/users/{userId}/{collectionName}/{docId}
            return doc(db, `artifacts/${appId}/users/${userId}/${TASK_COLLECTION_NAME}`, PROFILE_DOC_ID);
        }

        // [Task List CRUD]
        function loadTasks() {
            if (!isAuthReady || !userId || !db) return;
            const taskRef = getTasksCollectionRef();
            if (!taskRef) return;
            
            // onSnapshot se real-time updates milegi
            const q = query(taskRef, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                renderTasks(tasks);
            }, (error) => {
                console.error("Real-time tasks fetch error:", error);
            });
        }
        
        function renderTasks(tasks) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<p class="text-gray-500 text-center py-4">Koi task nahi! Neeche naya task jodein.</p>';
                return;
            }

            tasks.forEach(task => {
                const isDone = task.done || false;
                const listItem = document.createElement('li');
                listItem.className = `flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0 cursor-pointer hover:bg-gray-50 transition duration-150 rounded-lg ${isDone ? 'opacity-60' : ''}`;
                listItem.onclick = () => toggleTask(task.id, isDone);

                listItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" ${isDone ? 'checked' : ''} class="form-checkbox h-5 w-5 text-teal-500 rounded-md transition duration-150 ease-in-out" onclick="event.stopPropagation()">
                        <span class="text-sm ${isDone ? 'task-done' : 'text-gray-800'}">${task.text}</span>
                    </div>
                    <button class="text-red-400 hover:text-red-600 transition duration-150" onclick="event.stopPropagation(); deleteTask('${task.id}')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                    </button>
                `;
                taskList.appendChild(listItem);
            });
        }

        window.addTask = async function() {
            if (!isAuthReady || !userId || !db) { console.error("Auth ready nahi."); return; }
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (text === "") return;
            const taskRef = getTasksCollectionRef();
            if (!taskRef) return;
            try {
                await addDoc(taskRef, { text: text, done: false, createdAt: serverTimestamp() });
                input.value = '';
            } catch (error) { console.error("Task add karne mein error:", error); }
        }
        
        window.deleteTask = async function(id) {
            if (!isAuthReady || !userId || !db) return;
            const taskRef = getTasksCollectionRef();
            if (!taskRef) return;
            try {
                const docRef = doc(taskRef, id);
                await deleteDoc(docRef);
            } catch (error) { console.error("Task delete karne mein error:", error); }
        }
        
        // Advanced Feature: Saare tasks clear karne ka button
        window.clearAllTasks = async function() {
             if (!isAuthReady || !userId || !db) { console.error("Auth ready nahi."); return; }
             const confirmation = true; // No confirm dialogs are allowed in immersive, so assume true for functionality
             if (!confirmation) return;

             const taskRef = getTasksCollectionRef();
             if (!taskRef) return;

             try {
                // Fetch all documents and delete them one by one
                const snapshot = await getDocs(taskRef);
                const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletePromises);
                console.log("All tasks cleared successfully.");
             } catch (error) {
                 console.error("Saare tasks clear karne mein error:", error);
             }
        }


        // --- Gemini API Logic (General Text/JSON/Chat) ---
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
        const API_KEY = ""; 

        async function callGeminiApi(model, contents, systemPrompt = null, useGrounding = false, responseSchema = null, maxRetries = 3) {
            const apiUrl = `${API_BASE_URL}${model}:generateContent?key=${API_KEY}`;
            const contentArray = Array.isArray(contents) ? contents : [{ parts: [{ text: contents }] }];

            const payload = {
                contents: contentArray, 
                systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined,
                tools: useGrounding ? [{ "google_search": {} }] : undefined,
                generationConfig: responseSchema ? {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                } : undefined,
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    
                    if (responseSchema) {
                         const jsonText = candidate?.content?.parts?.[0]?.text;
                         return JSON.parse(jsonText);
                    }

                    const text = candidate?.content?.parts?.[0]?.text || "Sorry, I could not find a response.";
                    
                    let sources = [];
                    const groundingMetadata = candidate?.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions.map(attr => ({
                            uri: attr.web?.uri,
                            title: attr.web?.title,
                        })).filter(source => source.uri);
                    }
                    
                    return { text, sources };

                } catch (error) {
                    console.error("API call mein error:", error);
                    return responseSchema ? null : { text: "API call ke dauraan ek gambhir error hua.", sources: [] };
                }
            }
            return responseSchema ? null : { text: "Maximum retries fail ho gaye.", sources: [] };
        }
        
        // --- Gemini TTS API Logic (Text-to-Speech) ---
        async function callGeminiTts(text, voiceName = "Zephyr", languageCode = "en-US", maxRetries = 3) {
            const apiUrl = `${API_BASE_URL}gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName },
                            languageCode: languageCode
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }

                    if (!response.ok) {
                        throw new Error(`TTS API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    
                    if (audioData) {
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData); 
                        return pcmToWav(pcm16, 16000);
                    }
                    return null;

                } catch (error) {
                    console.error("TTS API call mein error:", error);
                    return null;
                }
            }
            return null;
        }


        // [Chat Logic]
        window.sendMessage = async function() {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            input.value = '';
            document.getElementById('chat-send-btn').disabled = true;

            const chatbox = document.getElementById('chat-history');
            
            // 1. User message ko history mein jodein
            chatHistory.push({ role: "user", parts: [{ text: query }] }); 
            appendMessage(query, 'user');

            const loadingElement = appendLoading();
            chatbox.scrollTop = chatbox.scrollHeight;

            const systemPrompt = "Aap TUSHARA AI hain, jo SUJAL MEMAWAT ke liye ek madadgar, polite aur jaankaar assistant hain. Aap ek multi-turn conversation kar rahe hain, isliye pichle messages se context banaaye rakhiye. Apne jawaab hamesha Romanized Hindi (Hinglish) mein dijiye, jisse user ko aasani ho.";

            try {
                // 2. Pure chatHistory ko API ko bhejein
                const result = await callGeminiApi(
                    "gemini-2.5-flash-preview-09-2025", 
                    chatHistory, 
                    systemPrompt, 
                    true 
                );

                const text = result.text;
                
                loadingElement.remove();
                appendMessage(text, 'ai', result.sources);
                
                // 3. Model response ko history mein jodein
                chatHistory.push({ role: "model", parts: [{ text: text }] });

            } catch (error) {
                loadingElement.remove();
                appendMessage("Conversation ke dauraan ek error hua. (Contextual Memory Error)", 'ai');
            }

            document.getElementById('chat-send-btn').disabled = false;
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        function appendMessage(text, sender, sources = []) {
            const chatbox = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            
            let sourceHtml = '';
            if (sender === 'ai' && sources.length > 0) {
                sourceHtml = `<div class="mt-2 pt-2 border-t border-teal-200 text-xs text-teal-700">
                    <p class="font-semibold mb-1">Sources (Jaankari ke Srot):</p>
                    ${sources.slice(0, 3).map(s => 
                        `<a href="${s.uri}" target="_blank" class="block truncate hover:underline" title="${s.title}">${s.title || s.uri}</a>`
                    ).join('')}
                </div>`;
            }

            messageDiv.className = `chat-message ${sender} max-w-[85%] p-3 my-2 rounded-xl text-sm break-words`;
            messageDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>${sourceHtml}`;
            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        }
        
        function appendLoading() {
            const chatbox = document.getElementById('chat-history');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message ai max-w-xs p-3 my-2 rounded-xl';
            loadingDiv.innerHTML = '<div class="loading-spinner"></div>';
            chatbox.appendChild(loadingDiv);
            return loadingDiv;
        }
        
        // Advanced Feature: Chat history clear karne ka function
        window.clearChatHistory = function() {
            chatHistory = [];
            const chatbox = document.getElementById('chat-history');
            chatbox.innerHTML = `
                <div class="chat-message ai max-w-[85%] p-3 rounded-xl text-sm bg-teal-100 border-top-left-radius: 0;">
                    <p>Chat history saaf kar di gayi hai. Hum naye sire se shuru kar sakte hain!</p>
                </div>
            `;
            chatbox.scrollTop = chatbox.scrollHeight;
        }


        // --- Adaptive 3D Style Profile Logic ---

        // Profile ki jaankari load karna
        async function getStyleProfile() {
            if (!isAuthReady || !userId || !db) return null;
            const docRef = getProfileDocRef();
            const statusDisplay = document.getElementById('profile-status');
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const profile = docSnap.data().profile;
                    statusDisplay.textContent = `Profile: Loaded! Role: ${profile.profession}, Style: ${profile.favoriteStyle}, Body: ${profile.bodyType}`;
                    return profile;
                } else {
                    statusDisplay.textContent = 'Profile: Set nahi hai. Kripya apni pasand save karein!';
                    return null;
                }
            } catch (error) {
                console.error("Style profile fetch karne mein error:", error);
                statusDisplay.textContent = 'Profile: Load hone mein error.';
                return null;
            }
        }

        // Advanced Feature: Profile save karna (Body Type ke saath)
        window.saveStyleProfile = async function() {
            if (!isAuthReady || !userId || !db) { console.error("Auth ready nahi."); return; }
            const input = document.getElementById('profile-input');
            const statusDisplay = document.getElementById('profile-status');
            const prompt = input.value.trim();
            if (!prompt) return;

            statusDisplay.textContent = 'AI se input analyze kar rahe hain...';

            const profileSchema = {
                type: "OBJECT",
                properties: {
                    profession: { type: "STRING", description: "The user's profession or role (e.g., 'Software Engineer', 'CEO', 'Student')" },
                    bodyType: { type: "STRING", description: "The user's estimated body type based on the description (e.g., 'Slim and Tall', 'Muscular', 'Average')" },
                    favoriteStyle: { type: "STRING", description: "A summary of their preferred clothing style (e.g., 'minimalist', 'vibrant', 'traditional')" },
                    favoriteColors: { type: "ARRAY", items: { type: "STRING" }, description: "A list of 2-3 colors the user often likes to wear" },
                },
                required: ["profession", "bodyType", "favoriteStyle", "favoriteColors"]
            };

            const systemPrompt = `Aapko user ke free-form text ko analyze karke unka professional role, unka body type (bahut zaroori), preferred style, aur 2-3 favorite colors nikalne hain. Output ko sakhti se JSON format mein dein.`;
            
            try {
                const profileData = await callGeminiApi(
                    "gemini-2.5-flash-preview-09-2025", 
                    prompt, 
                    systemPrompt, 
                    false, 
                    profileSchema
                );

                if (profileData && profileData.profession) {
                    const docRef = getProfileDocRef();
                    await setDoc(docRef, { profile: profileData, updatedAt: serverTimestamp() });
                    input.value = '';
                    getStyleProfile(); 
                } else {
                    statusDisplay.textContent = 'Profile parse nahi ho paya. Kripya saaf tarah se likhein.';
                }
            } catch (error) {
                console.error("Profile save karne mein error:", error);
                statusDisplay.textContent = 'Profile cloud mein save karne mein error.';
            }
        }


        // --- 3D Visualization Logic (Three.js) ---
        function init3D() {
            const container = document.getElementById('three-container');
            if (!container || is3DInit) return;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f4f8); 
            
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 3;
            camera.position.y = 1;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 3);
            light.position.set(1, 1, 1).normalize();
            scene.add(light);
            const ambient = new THREE.AmbientLight(0x404040, 5); 
            scene.add(ambient);

            avatarGroup = new THREE.Group();
            scene.add(avatarGroup);
            
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            // Mouse aur Touch Event Listeners 3D rotation ke liye (mobile friendly)
            container.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition.x = e.clientX;
                previousMousePosition.y = e.clientY;
            });

            container.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - previousMousePosition.x;
                avatarGroup.rotation.y += deltaX * 0.01;
                previousMousePosition.x = e.clientX;
                previousMousePosition.y = e.clientY;
            });

            container.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            container.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                previousMousePosition.x = e.touches[0].clientX;
                previousMousePosition.y = e.touches[0].clientY;
            }, { passive: false });

            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDragging) return;
                const deltaX = e.touches[0].clientX - previousMousePosition.x;
                avatarGroup.rotation.y += deltaX * 0.01;
                previousMousePosition.x = e.touches[0].clientX;
            }, { passive: false });

            container.addEventListener('touchend', () => {
                isDragging = false;
            });
            
            window.addEventListener('resize', onResize, false);

            function onResize() {
                const width = container.clientWidth;
                const height = container.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
            
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
            
            is3DInit = true;
            render3DLook({
                topColor: '#5B7C99',
                bottomColor: '#5B7C99',
                shoeColor: '#6B7280',
                accessory: 'Brown Belt',
                styleNotes: 'Yeh 3D visualization ka preview hai. Nayi advice ke liye request daalein!',
                lookTitle: 'Default Professional Look'
            });
        }
        
        // Color string ko Three.js Color object mein badalna
        function getColor(colorString) {
            try {
                if (colorString && colorString.startsWith('#')) {
                    return new THREE.Color(colorString);
                }
            } catch (e) {}
            // Common colors ke liye mapping
            const lowerCaseColor = (colorString || '').toLowerCase();
            if (lowerCaseColor.includes('blue')) return new THREE.Color(0x3B82F6);
            if (lowerCaseColor.includes('gray') || lowerCaseColor.includes('grey')) return new THREE.Color(0x6B7280);
            if (lowerCaseColor.includes('white')) return new THREE.Color(0xFFFFFF);
            if (lowerCaseColor.includes('black')) return new THREE.Color(0x1F2937);
            if (lowerCaseColor.includes('red')) return new THREE.Color(0xEF4444);
            if (lowerCaseColor.includes('green')) return new THREE.Color(0x10B981);
            if (lowerCaseColor.includes('beige') || lowerCaseColor.includes('brown')) return new THREE.Color(0x8B4513);
            if (lowerCaseColor.includes('navy')) return new THREE.Color(0x1A237E);
            if (lowerCaseColor.includes('khaki')) return new THREE.Color(0xC3B091);

            return new THREE.Color(0xAAAAAA); 
        }

        function render3DLook(styleData) {
            if (!avatarGroup) {
                return;
            }

            // Purane avatar elements ko hata dein
            while (avatarGroup.children.length > 0) {
                avatarGroup.remove(avatarGroup.children[0]);
            }

            const topColor = getColor(styleData.topColor);
            const bottomColor = getColor(styleData.bottomColor);
            const shoeColor = getColor(styleData.shoeColor);

            // Floor (Zameen) ko ek baar hi add karein
            if (scene.children.filter(c => c.name === 'Floor').length === 0) {
                const planeGeometry = new THREE.PlaneGeometry(5, 5);
                const planeMaterial = new THREE.MeshPhongMaterial({ color: 0xCCCCCC, side: THREE.DoubleSide });
                const plane = new THREE.Mesh(planeGeometry, planeMaterial);
                plane.rotation.x = Math.PI / 2;
                plane.position.y = -0.5;
                plane.name = 'Floor';
                scene.add(plane);
            }
            
            // --- Body/Shirt (Simplified Avatar) ---
            const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.4, 1.0, 16);
            const topMaterial = new THREE.MeshPhongMaterial({ color: topColor });
            const body = new THREE.Mesh(bodyGeometry, topMaterial);
            body.position.y = 1.0;
            avatarGroup.add(body);
            
            // --- Trousers ---
            const lowerBodyGeometry = new THREE.CylinderGeometry(0.2, 0.3, 1.0, 16);
            const bottomMaterial = new THREE.MeshPhongMaterial({ color: bottomColor });
            const lowerBody = new THREE.Mesh(lowerBodyGeometry, bottomMaterial);
            lowerBody.position.y = 0.0;
            avatarGroup.add(lowerBody);
            
            // --- Head ---
            const headGeometry = new THREE.SphereGeometry(0.25, 32, 32);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xFFDBAC }); 
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.6;
            avatarGroup.add(head);

            // --- Shoes ---
            const shoeGeometry = new THREE.BoxGeometry(0.25, 0.15, 0.35);
            const shoeMaterial = new THREE.MeshPhongMaterial({ color: shoeColor });
            
            const leftShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            leftShoe.position.set(-0.15, -0.45, 0);
            avatarGroup.add(leftShoe);

            const rightShoe = new THREE.Mesh(shoeGeometry, shoeMaterial);
            rightShoe.position.set(0.15, -0.45, 0);
            avatarGroup.add(rightShoe);


            // UI Text Update karein
            document.getElementById('look-title').textContent = styleData.lookTitle || 'Generated Style';
            document.getElementById('style-notes').innerHTML = styleData.styleNotes ? 
                styleData.styleNotes.replace(/\n/g, '<br>') : 
                '**Details:** Koi detail available nahi, lekin 3D look update ho gaya hai.';

            document.getElementById('style-details').innerHTML = `
                <p><strong>Top (Shirt/Jacket):</strong> ${styleData.topColor}</p>
                <p><strong>Bottom (Pants/Skirt):</strong> ${styleData.bottomColor}</p>
                <p><strong>Shoes (Jootey):</strong> ${styleData.shoeColor}</p>
                <p><strong>Accessory (Samaan):</strong> ${styleData.accessory}</p>
            `;
            
            avatarGroup.rotation.y = 0.5;
        }


        // --- AI Style, 3D Viewer, Voice Assistant Logic (Main Function) ---
        
        window.generate3DLook = async function() {
            if (!isAuthReady || !userId) { 
                // Custom Modal UI for error (no alert())
                document.getElementById('style-notes').innerHTML = '<p class="text-red-500">Kripya Firebase sign-in complete hone ka intezaar karein.</p>';
                return;
            }
            const topicInput = document.getElementById('creative-topic');
            const topic = topicInput.value.trim();
            const resultBox = document.getElementById('style-result-container');
            const audioPlayer = document.getElementById('audio-player');
            
            if (!topic) {
                resultBox.querySelector('#style-notes').innerHTML = '<p class="text-red-500">Kripya occasion/request likhein.</p>';
                return;
            }

            document.getElementById('creative-generate-btn').disabled = true;
            resultBox.querySelector('#style-notes').innerHTML = '<div class="flex items-center space-x-2 text-teal-600"><div class="loading-spinner"></div><span>3D look aur voice advice generate ho rahi hai...</span></div>';
            resultBox.querySelector('#look-title').textContent = 'Loading...';
            resultBox.querySelector('#style-details').innerHTML = '';
            audioPlayer.removeAttribute('src'); 

            // 1. Personalized profile laayein
            const userProfile = await getStyleProfile();
            let profileContext = userProfile ? 
                `The user's profile is: Profession: ${userProfile.profession}, Body Type: ${userProfile.bodyType}, Style: ${userProfile.favoriteStyle}, Colors: ${userProfile.favoriteColors.join(', ')}. Use this information strongly to suggest clothing that is UNIQUE and BEST SUITED for their body type and role.` :
                "No user profile set. Provide general professional advice, emphasizing suitability.";
            
            const fullQuery = `${profileContext} The occasion/request is: ${topic}`;


            const responseSchema = {
                type: "OBJECT",
                properties: {
                    lookTitle: { type: "STRING", description: "The title of the style, e.g., 'CEO Power Look'" },
                    topColor: { type: "STRING", description: "The color of the top/shirt (hex code or common name)" },
                    bottomColor: { type: "STRING", description: "The color of the pants/skirt (hex code or common name)" },
                    shoeColor: { type: "STRING", description: "The color of the shoes (hex code or common name)" },
                    accessory: { type: "STRING", description: "A main accessory (e.g.: 'Silver Watch' or 'Slim Tie')" },
                    styleNotes: { type: "STRING", description: "A 3-4 line professional English description of the style, explaining WHY it suits their body type/role." }
                },
                required: ["lookTitle", "topColor", "bottomColor", "shoeColor", "accessory", "styleNotes"]
            };

            const styleSystemPrompt = `You are a world-class Adaptive Style Consultant (TUSHARA AI). Your goal is to suggest an appropriate outfit and explain why it is the MOST UNIQUE and BEST SUITED for the user's specific body type, role, and stated occasion. ALWAYS prioritize the user profile in your suggestions. Your output must strictly follow the JSON schema.`;
            
            try {
                // 2. JSON Style Data generate karein
                const styleData = await callGeminiApi(
                    "gemini-2.5-flash-preview-09-2025", 
                    fullQuery, 
                    styleSystemPrompt, 
                    false, 
                    responseSchema 
                );
                
                if (styleData && styleData.topColor) {
                    // 3. 3D Look Render karein
                    render3DLook(styleData);
                    
                    // 4. TTS Text taiyar karein (aur zyada personalized aur detailed)
                    const ttsText = `Greetings! I am TUSHARA, your speaking style assistant. Based on your profile and the occasion, I have designed this unique look for you. The outfit is titled: ${styleData.lookTitle}. I have selected a ${styleData.topColor} top and ${styleData.bottomColor} bottoms, paired with ${styleData.shoeColor} shoes. I recommend adding a ${styleData.accessory}. The AI has determined this combination is particularly well-suited for your profile because ${styleData.styleNotes.replace(/<br>/g, ' ')}. Look amazing!`;

                    // 5. TTS Audio generate karein
                    resultBox.querySelector('#style-notes').innerHTML = '<div class="flex items-center space-x-2 text-teal-600"><div class="loading-spinner"></div><span>AI ab advice bol raha hai... Kripya intezaar karein.</span></div>';
                    
                    const audioBlob = await callGeminiTts(ttsText, "Zephyr", "en-US");

                    // 6. Audio Play karein
                    if (audioBlob) {
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPlayer.src = audioUrl;
                        audioPlayer.play().catch(e => console.error("Audio play error:", e));
                        resultBox.querySelector('#style-notes').innerHTML = styleData.styleNotes.replace(/\n/g, '<br>');
                    } else {
                         resultBox.querySelector('#style-notes').innerHTML = '<p class="text-orange-500">Audio generate nahi ho paya, lekin 3D look taiyar hai.</p>';
                    }

                } else {
                    resultBox.querySelector('#style-notes').innerHTML = '<p class="text-red-500">AI se style data nahi mil paya. Kripya phir se koshish karein.</p>';
                }

            } catch (error) {
                resultBox.querySelector('#style-notes').innerHTML = '<p class="text-red-500">3D look aur audio generate karne mein error.</p>';
            }

            document.getElementById('creative-generate-btn').disabled = false;
        }

        // --- UI/Tab Logic ---
        window.changeTab = function(tabName) {
            // 'tools' ko 'style-voice' se badla gaya
            const tabs = ['chat', 'tasks', 'style-voice'];
            
            tabs.forEach(tab => {
                document.getElementById(`${tab}-content`).classList.add('hidden');
                document.getElementById(`${tab}-btn`).classList.remove('active');
            });
            
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById(`${tabName}-btn`).classList.add('active');
            
            if (tabName === 'style-voice' && !is3DInit) {
                init3D();
            } else if (tabName === 'chat') {
                const chatbox = document.getElementById('chat-history');
                chatbox.scrollTop = chatbox.scrollHeight;
            }
        }
        
        // Startup
        window.onload = function() {
            setupFirebase();
            changeTab('chat');
        };

    </script>
</head>
<body class="p-4 bg-gray-100">
    <div class="container rounded-2xl overflow-hidden shadow-2xl">
        
        <!-- Header -->
        <header class="p-4 bg-teal-600 text-white shadow-lg">
            <h1 class="text-2xl font-bold text-center">TUSHARA Assistant <span class="text-sm text-teal-200">(AGI Mode)</span></h1>
            <p id="user-id-display" class="text-xs text-center mt-1 opacity-80"></p>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-around bg-white border-b border-gray-200">
            <button id="chat-btn" class="tab-button flex-1 py-3 text-center text-sm text-gray-700 hover:text-teal-600" onclick="changeTab('chat')">
                üß† Contextual Chat
            </button>
            <button id="tasks-btn" class="tab-button flex-1 py-3 text-center text-sm text-gray-700 hover:text-teal-600" onclick="changeTab('tasks')">
                ‚úÖ Task List
            </button>
            <button id="style-voice-btn" class="tab-button flex-1 py-3 text-center text-sm text-gray-700 hover:text-teal-600" onclick="changeTab('style-voice')">
                üßë‚Äçüé§ Adaptive Style & Voice
            </button>
        </nav>

        <!-- Content Area -->
        <main class="flex-grow p-4 overflow-auto">
            
            <!-- 1. Contextual Chat Content -->
            <section id="chat-content" class="h-full flex flex-col hidden">
                <p class="text-xs text-center text-gray-500 p-2 bg-indigo-50 rounded-lg mb-3">
                    **ADVANCED FEATURE:** Chat ab context yaad rakhta hai! Hindi (Romanized) mein baat karein.
                </p>
                <div id="chat-history" class="flex-grow overflow-y-auto p-2 mb-4 space-y-3 bg-gray-50 rounded-lg border">
                    <div class="chat-message ai max-w-[85%] p-3 rounded-xl text-sm bg-teal-100 border-top-left-radius: 0;">
                        <p>Hello! Main TUSHARA Assistant hoon. Ab main hamaari poori baat-cheet yaad rakh sakta hoon. Chaliye, shuru karte hain!</p>
                    </div>
                </div>
                
                <!-- Chat Actions and Input -->
                <div class="mb-3">
                    <button onclick="clearChatHistory()" class="text-xs text-red-500 hover:text-red-700 font-semibold transition duration-150">
                        üóëÔ∏è Chat History Saaf Karein
                    </button>
                </div>

                <div class="flex items-center">
                    <input type="text" id="chat-input" placeholder="Yahan apna message type karein..." 
                           class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm"
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button id="chat-send-btn" onclick="sendMessage()" 
                            class="bg-teal-500 hover:bg-teal-600 text-white p-3 rounded-r-xl transition duration-150 shadow-md">
                        Bhejein
                    </button>
                </div>
            </section>

            <!-- 2. Task List Content -->
            <section id="tasks-content" class="h-full flex flex-col hidden">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">‚úÖ Mere Tasks (Cloud par save hain)</h2>

                <div class="flex mb-4">
                    <input type="text" id="new-task-input" placeholder="Naya Task jodein (eg. Project report taiyar karein)"
                           class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 text-sm"
                           onkeypress="if(event.key === 'Enter') addTask()">
                    <button onclick="addTask()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-r-xl transition duration-150 shadow-md">
                        Jodein
                    </button>
                </div>
                
                 <!-- Task Actions -->
                <div class="mb-3">
                    <button onclick="clearAllTasks()" class="text-xs text-red-500 hover:text-red-700 font-semibold transition duration-150">
                        üóëÔ∏è Saare Tasks Hataayein
                    </button>
                </div>

                <ul id="task-list" class="bg-white rounded-lg border border-gray-200 divide-y divide-gray-100 shadow-sm">
                    <!-- Tasks yahan load honge -->
                </ul>
                
                <p class="text-xs text-center text-gray-500 mt-4 p-2 bg-yellow-50 rounded-lg">
                    **Note:** Yeh list aapke User ID ke aadhaar par cloud (Firestore) mein save ki jaati hai.
                </p>
            </section>

            <!-- 3. AI Style and 3D Viewer Content -->
            <section id="style-voice-content" class="h-full flex flex-col hidden">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">üéôÔ∏è Adaptive Style aur Voice Consultant</h2>

                <!-- Advanced Feature: Style Profile Setup -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
                    <h4 class="text-md font-bold text-yellow-800 mb-2">üöÄ Sabse Advanced Personalization: Apna Style Profile Set Karein!</h4>
                    <p class="text-sm text-yellow-700 mb-2 font-medium">Apna role, body type, aur pasandida style batayein. AI iska upyog aapke liye **sabse unique aur sahi** dress code batane mein karega.</p>
                    <input type="text" id="profile-input" placeholder="Jaise: 'Main patla aur lamba hoon, main ek programmer hoon, mujhe minimalist aur dark color suits pasand hain'"
                           class="w-full p-2 border border-yellow-300 rounded-md focus:ring-1 focus:ring-yellow-500 mb-2 text-xs">
                    <button onclick="saveStyleProfile()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-2 text-xs rounded-md w-full transition duration-150 font-bold">
                        AI Profile Save Karein
                    </button>
                    <p id="profile-status" class="text-xs mt-2 text-center text-yellow-800 font-medium">Profile: Load ho raha hai...</p>
                </div>

                <p class="mb-3 text-sm text-gray-600">
                    Occasion/request likhein, jiske liye aapko style advice chahiye.
                </p>
                
                <input type="text" id="creative-topic" placeholder="Occasion likhein (eg.: 'Shaam ki party ke liye kya pehnu?')..." 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 mb-4 text-sm">
                
                <button id="creative-generate-btn" onclick="generate3DLook()" 
                        class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg transition duration-150 shadow-md font-extrabold mb-6">
                    3D Look aur Voice Advice Generate Karein
                </button>
                
                <!-- Audio Player -->
                <audio id="audio-player" controls class="w-full mb-4 rounded-lg shadow-inner"></audio>

                <!-- 3D Viewer Container -->
                <div id="three-container" class="mb-4">
                    <!-- Three.js Canvas yahan render hoga -->
                </div>

                <!-- Style Result -->
                <div id="style-result-container" class="bg-white p-4 rounded-lg border border-gray-200 shadow-xl">
                    <h3 id="look-title" class="text-md font-bold mb-2 text-teal-700 border-b pb-1">Default Professional Look</h3>
                    
                    <div id="style-details" class="text-sm text-gray-600 mb-3">
                        <!-- Style Details yahan aayenge -->
                    </div>

                    <p id="style-notes" class="text-gray-800 text-sm italic font-medium">
                         Yeh 3D visualization ka preview hai. Nayi advice ke liye request daalein!
                    </p>
                </div>
            </section>

        </main>
        
        <!-- Footer -->
        <footer class="p-2 bg-gray-200 text-xs text-center text-gray-600 border-t border-gray-300">
            TUSHARA Assistant (Creative Owner: SUJAL MEMAWAT) - Sabhi Adhikar Surakshit, ${new Date().getFullYear()}
        </footer>
    </div>
    <script type="module">
  // Firebase SDKs ‡§ï‡•ã Import ‡§ï‡§∞‡•á‡§Ç
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // ‡§Ü‡§™‡§ï‡•Ä script.js ‡§Æ‡•á‡§Ç Firestore ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ø‡§π‡§æ‡§Ç ‡§î‡§∞ SDKs ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à 
  
  // ‡§Ü‡§™‡§ï‡§æ Firebase ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§®
  const firebaseConfig = {
    apiKey: "AIzaSyDSlpSnkKyMJJz1Sf0ffClEQS6208Oovso",
    authDomain: "tushara-assistant.firebaseapp.com",
    projectId: "tushara-assistant",
    storageBucket: "tushara-assistant.firebasestorage.app",
    messagingSenderId: "825591383486",
    appId: "1:825591383486:web:7a617144d4080f201b25ef",
    measurementId: "G-M7C3FK5FF9"
  };

  // Firebase ‡§ï‡•ã ‡§á‡§®‡§ø‡§∂‡§ø‡§Ø‡§≤‡§æ‡§á‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

<script type="module" src="script.js"></script>
</body>
</html>

